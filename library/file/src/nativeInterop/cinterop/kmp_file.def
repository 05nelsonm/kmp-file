package = io.matthewnelson.kmp.file.internal
---
#ifdef _WIN32
#include <fileapi.h>
#include <winnt.h>
#else
#include <sys/stat.h>
#include <stdint.h>
#include <errno.h>
#endif // _WIN32

#ifdef __APPLE__
#include <fcntl.h>
#include <sys/mount.h>
#include <unistd.h>
#endif // __APPLE__

int
#ifdef _WIN32
kmp_file_fsize(HANDLE h, DWORD size[2])
#else
kmp_file_fsize(int fd, int64_t size[1])
#endif // _WIN32
{
  if (!size) {
    return -1;
  }
#ifdef _WIN32

  LARGE_INTEGER buf = {0};
  if (GetFileSizeEx(h, &buf) == FALSE) {
    return -1;
  }
  size[0] = buf.HighPart;
  size[1] = buf.LowPart;
  return 0;
#else

  int           ret = -1;
#ifdef __ANDROID__
  struct stat64 buf;
#else
  struct stat   buf;
#endif __ANDROID__

  do {
#ifdef __ANDROID__
    ret = fstat64(fd, &buf);
#else
    ret = fstat(fd, &buf);
#endif
  } while (ret == -1 && errno == EINTR);
  if (ret == -1) {
    return -1;
  }
  size[0] = buf.st_size;
  return 0;
#endif // _WIN32
}

#ifndef _WIN32
int
kmp_file_fis_directory(int fd)
{
  int         ret = -1;
  struct stat buf;

  do {
    ret = fstat(fd, &buf);
  } while (ret == -1 && errno == EINTR);
  if (ret == -1) {
    return -1;
  }
  if ((buf.st_mode & S_IFMT) == S_IFDIR) {
    return 1;
  } else {
    return 0;
  }
}
#endif

#ifdef __APPLE__
int
kmp_file_fullfsync(int fd)
{
  int           ret = -1;

  do {
    ret = fcntl(fd, F_FULLFSYNC);
  } while (ret == -1 && errno == EINTR);
  if (ret == -1) {
    return -1;
  }

  int           saved = errno;
  struct statfs buf;

  ret = -1;
  do {
    ret = fstatfs(fd, &buf);
  } while (ret == -1 && errno == EINTR);
  if (ret != 0) {
    errno = saved;
    return -1;
  }
  if ((buf.f_flags & MNT_LOCAL) != 0) {
    return -1;
  }

  // Non-local file or directory. Try fsync.
  ret = -1;
  do {
    ret = fsync(fd);
  } while (ret == -1 && errno == EINTR);
  return ret;
}
#endif // __APPLE__
